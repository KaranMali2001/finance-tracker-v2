#!/usr/bin/env sh

echo "üîß Running pre-commit formatting..."

# Get the git root directory (project root)
GIT_ROOT=$(git rev-parse --show-toplevel)

# Format Go backend code
echo "üìù Formatting Go files..."

# Get list of staged Go files before formatting (relative to git root)
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$STAGED_GO_FILES" ]; then
  # Format only staged Go files
  if command -v gofumpt >/dev/null 2>&1; then
    echo "$STAGED_GO_FILES" | while read -r file; do
      [ -f "$GIT_ROOT/$file" ] && gofumpt -w "$GIT_ROOT/$file"
    done
    echo "‚úì Go files formatted with gofumpt"
  else
    echo "‚ö†Ô∏è  gofumpt not found, install with: go install mvdan.cc/gofumpt@latest"
  fi

  if command -v goimports >/dev/null 2>&1; then
    echo "$STAGED_GO_FILES" | while read -r file; do
      [ -f "$GIT_ROOT/$file" ] && goimports -w "$GIT_ROOT/$file"
    done
    echo "‚úì Go imports organized with goimports"
  else
    echo "‚ö†Ô∏è  goimports not found, install with: go install golang.org/x/tools/cmd/goimports@latest"
  fi

  # Stage the formatted Go files
  echo "$STAGED_GO_FILES" | while read -r file; do
    [ -f "$GIT_ROOT/$file" ] && git add "$GIT_ROOT/$file"
  done
  echo "‚úì Formatted Go files staged"
fi

# Format Next.js/TypeScript/SQL files using lint-staged
cd "$GIT_ROOT/finance-tracker-web"

echo "üìù Formatting frontend files..."

npx lint-staged

echo "‚úÖ Pre-commit formatting complete!"
